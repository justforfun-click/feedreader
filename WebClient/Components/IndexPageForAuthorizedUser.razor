@implements IDisposable
@inject FeedService FeedService
@inject LocalUser LocalUser

<MainLayout>
    <div class="authorized-user-page">
        <div class="left-panel">
            <div class="section">
                <div class="header">
                    <div class="name">Feeds</div>
                    <div class="toolbar">
                        <div class="icon" title="add new feed" @onclick="AddNewFeed">
                            <!-- comes from open-iconic: plus -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
                                <path d="M3 0v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="feed-group-list">
                    @foreach (var group in LocalUser.Feeds.GroupBy(f => f.Group))
                    {
                        <div class="group">
                            <div class="header">
                                <div class="icon">
                                    <!-- comes from open-iconic: book -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
                                        <path d="M1 0c-.07 0-.13.01-.19.03-.39.08-.7.39-.78.78-.03.06-.03.12-.03.19v5.5c0 .83.67 1.5 1.5 1.5h5.5v-1h-5.5c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h5.5v-5.5c0-.28-.22-.5-.5-.5h-.5v3l-1-1-1 1v-3h-3z" />
                                    </svg>
                                </div>
                                <div class="name" title="@group.Key"><span>@group.Key</span></div>
                            </div>
                            <div class="feed-list">
                                @foreach (var feed in group)
                                {
                                    <div class="feed" @onclick="() => ShowFeed(feed)">
                                        <img src="@feed.IconUri"/>
                                        <div class="name" title="@feed.Name"><span>@feed.Name</span></div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="right-panel">
            @RightPanelContent
        </div>
    </div>
</MainLayout>

@code
{
    private RenderFragment RightPanelContent { get; set; }

    protected override void OnInitialized()
    {
        FeedService.RefreshRequested += OnRefreshRequested;
        ShowFeed();
    }

    public void Dispose()
    {
        FeedService.RefreshRequested -= OnRefreshRequested;
    }

    private void AddNewFeed()
    {
        RightPanelContent = @<AddNewFeed OnCancel="Cancel" OnSave="SaveNewFeed"/>;
    }

    private void SaveNewFeed(Feed feed)
    {
        // Display the feed.
        ShowFeed(feed);

        // Subscribe the feed.
        _ = LocalUser.SubscribeFeedAsync(feed);
    }

    private void ShowFeed(Feed feed = null)
    {
        feed = feed ?? LocalUser.Feeds.FirstOrDefault();
        if (feed != null)
        {
            RightPanelContent = @<ShowFeed Feed=@feed OnUnsubscribe="Unsubscribe"/>;

            // Refresh the feed.
            _ = FeedService.RefreshFeedAsync(feed);
        }
        else
        {
            AddNewFeed();
        }
    }

    private void Cancel()
    {
        RightPanelContent = @<div></div>;
    }

    private void Unsubscribe(Feed feed)
    {
        _ = LocalUser.UnsubscribeFeedAsync(feed);
        ShowFeed();
    }

    private void OnRefreshRequested()
    {
        StateHasChanged();
    }
}
