@implements IDisposable
@inject FeedService FeedService
@inject IJSRuntime JsRuntime
@inject LocalUser LocalUser
@inject NavigationManager Navigation

<MainLayout>
    <div class="authorized-user-page">
        <div class="left-panel">
            <div class="section">
                <div class="header">
                    <div class="name">Feeds</div>
                    <div class="toolbar">
                        <div class="icon" title="add new feed" @onclick="AddNewFeed">
                            <!-- comes from open-iconic: plus -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
                                <path d="M3 0v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="feed-group-list">
                    <div class="group group-explorer clickable">
                        <div class="header" @onclick="ShowExplorer">
                            <div class="icon">
                                <!-- comes from open-iconic: aperture -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
                                  <path d="M4 0c-.69 0-1.34.19-1.91.5l3.22 2.34.75-2.25c-.6-.36-1.31-.59-2.06-.59zm-2.75 1.13c-.76.73-1.25 1.74-1.25 2.88 0 .25.02.48.06.72l3.09-2.22-1.91-1.38zm5.63.13l-1.22 3.75h2.19c.08-.32.16-.65.16-1 0-1.07-.44-2.03-1.13-2.75zm-4.72 3.22l-1.75 1.25c.55 1.13 1.6 1.99 2.88 2.22l-1.13-3.47zm1.56 1.53l.63 1.97c1.33-.12 2.46-.88 3.09-1.97h-3.72z"/>
                                </svg>
                            </div>
                            <div class="feed">
                                <div class="name"><span>Explorer</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="group group-stars clickable">
                        <div class="header clickable" @onclick="ShowStars">
                            <div class="icon">
                                <!-- comes from open-iconic: star -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
                                    <path d="M4 0l-1 3h-3l2.5 2-1 3 2.5-2 2.5 2-1-3 2.5-2h-3l-1-3z" />
                                </svg>
                            </div>
                            <div class="feed">
                                <div class="name"><span>Stars</span></div>
                            </div>
                        </div>
                    </div>

                    @foreach (var group in LocalUser.Feeds.GroupBy(f => f.Group))
                    {
                        <div class="group">
                            <div class="header">
                                <div class="icon">
                                    <!-- comes from open-iconic: book -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
                                        <path d="M1 0c-.07 0-.13.01-.19.03-.39.08-.7.39-.78.78-.03.06-.03.12-.03.19v5.5c0 .83.67 1.5 1.5 1.5h5.5v-1h-5.5c-.28 0-.5-.22-.5-.5s.22-.5.5-.5h5.5v-5.5c0-.28-.22-.5-.5-.5h-.5v3l-1-1-1 1v-3h-3z" />
                                    </svg>
                                </div>
                                <div class="name" title="Your Feeds - @group.Key"><span>Your Feeds - @group.Key</span></div>
                            </div>
                            <div class="feed-list">
                                @foreach (var feed in group)
                                {
                                    <div class="feed @(feed.IsActive ? "active" : "")" @onclick="() => ShowFeed(feed)">
                                        <FallbackImage Src="@feed.IconUri" FallbackSrc="@($"https://www.google.com/s2/favicons?domain={new Uri(feed.Uri).Host}")"/>
                                        <div class="name" title="@(string.IsNullOrWhiteSpace(feed.Name) ? feed.Uri : feed.Name)"><span>@(string.IsNullOrWhiteSpace(feed.Name) ? feed.Uri : feed.Name)</span></div>
                                        <div class="unreaded-items-count">@feed.Items.Count(i => !i.IsReaded).ToStringEmptyIfZero()</div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="right-panel" @onscroll="() => DropdownButton.HidePopupMenus()">
            @RightPanelContent
        </div>
        <div id="803822386" class="ad"/>
    </div>
</MainLayout>

@code
{
    private RenderFragment RightPanelContent { get; set; }

    protected override void OnInitialized()
    {
        FeedService.RefreshRequested += OnRefreshRequested;
        _ = JsRuntime.InvokeVoidAsync("showAd");

        var queryStart = Navigation.Uri.IndexOf('?');
        if (queryStart > 0)
        {
            var queries = HttpUtility.ParseQueryString(Navigation.Uri.Substring(queryStart + 1));
            if (queries?["action"] == "subscribe")
            {
                var feedOriginalUri = queries?["feed-original-uri"];
                if (!string.IsNullOrWhiteSpace(feedOriginalUri))
                {
                    var feed = LocalUser.Feeds.FirstOrDefault(f => f.Uri == feedOriginalUri.Trim().ToLower());
                    if (feed == null)
                    {
                        feed = new Feed() { Group = "Default", Uri = feedOriginalUri.Trim().ToLower(), OriginalUri = feedOriginalUri.Trim() };
                        ShowFeed(feed, subscribe: true);
                    }
                    else
                    {
                        ShowFeed(feed);
                    }
                    Navigation.NavigateTo("/");
                    return;
                }
            }
        }
        _ = ShowExplorer();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            _ = JsRuntime.InvokeVoidAsync("showAd");
        }
    }

    public void Dispose()
    {
        FeedService.RefreshRequested -= OnRefreshRequested;
    }

    private void AddNewFeed()
    {
        RightPanelContent = @<AddNewFeed OnCancel="Cancel" OnSave="(feed) => ShowFeed(feed, subscribe: true)"/>;
    }

    private async Task SubscribeFeed(Feed feed)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(feed.Group))
            {
                feed.Group = "Default";
            }
            await LocalUser.SubscribeFeedAsync(feed);
        }
        catch
        {
            feed.Error = "Subscribe failed. Please try it later.";
        }
    }

    private async void ShowFeed(Feed feed = null, bool subscribe = false)
    {
        await ShowActive("");

        feed = feed ?? LocalUser.Feeds.FirstOrDefault();
        if (feed != null)
        {
            feed.IsActive = true;

            RightPanelContent = @<ShowFeed Feed=@feed OnUnsubscribe="Unsubscribe"/>;

            if (subscribe)
            {
                await SubscribeFeed(feed);
            }

            // Refresh the feed.
            _ = FeedService.RefreshFeedAsync(feed);
        }
        else
        {
            AddNewFeed();
        }

        StateHasChanged();
    }

    private async Task ShowExplorer()
    {
        await ShowActive("group-explorer");

        RightPanelContent = @<FeedsExplorer OnSubscribe="SubscribeFeed" />;
    }

    private async Task ShowStars()
    {
        await ShowActive("group-stars");

        RightPanelContent = @<WaitingPage Text="Loading..."/>;

        var staredFeedItems = await LocalUser.GetStaredFeedItems();
        RightPanelContent = @<ShowStaredFeedItems StaredFeedItems="@staredFeedItems"/>;
    }

    private void Cancel()
    {
        RightPanelContent = @<div></div>;
    }

    private void Unsubscribe(Feed feed)
    {
        _ = LocalUser.UnsubscribeFeedAsync(feed);
        ShowFeed();
    }

    private void OnRefreshRequested()
    {
        StateHasChanged();
    }

    private async Task ShowActive(string itemName)
    {
        LocalUser.Feeds.ForEach(f => f.IsActive = false);
        await JsRuntime.InvokeVoidAsync("eval", $"document.querySelectorAll('.clickable').forEach(e => e.classList.remove('active'));");
        if (itemName.StartsWith("group-"))
        {
            await JsRuntime.InvokeVoidAsync("eval", $"document.querySelector('.{itemName}').classList.add('active');");
        }
    }
}
